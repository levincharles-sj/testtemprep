import org.apache.poi.ss.usermodel.*;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.Map;

public class ExcelReportGenerator {
    
    private static final IndexedColors LIGHT_BLUE = IndexedColors.PALE_BLUE;
    private static final IndexedColors LIGHT_GREEN = IndexedColors.LIGHT_GREEN;
    private static final IndexedColors PASS_GREEN = IndexedColors.GREEN;
    private static final IndexedColors FAIL_RED = IndexedColors.RED;
    
    public void generateInitialReport(String fileName, Map<String, Object[]> data, String tableTitle) {
        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("Sheet1");
            setupColumnWidths(sheet);
            createTable(workbook, sheet, data, tableTitle, 0);
            
            // Write the workbook to file
            try (FileOutputStream fileOut = new FileOutputStream(fileName)) {
                workbook.write(fileOut);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public void appendTableToExistingReport(String fileName, Map<String, Object[]> data, String tableTitle) {
        try {
            // Read existing file
            FileInputStream fis = new FileInputStream(new File(fileName));
            Workbook workbook = new XSSFWorkbook(fis);
            Sheet sheet = workbook.getSheetAt(0);
            
            // Find the last row of existing data
            int lastRowNum = findLastRowOfData(sheet);
            
            // Add new table with 2 rows gap
            int startRow = lastRowNum + 3;
            createTable(workbook, sheet, data, tableTitle, startRow);
            
            // Write back to file
            try (FileOutputStream fileOut = new FileOutputStream(fileName)) {
                workbook.write(fileOut);
            }
            
            fis.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private int findLastRowOfData(Sheet sheet) {
        int lastRowNum = sheet.getLastRowNum();
        for (int i = lastRowNum; i >= 0; i--) {
            Row row = sheet.getRow(i);
            if (row != null) {
                Cell cell = row.getCell(0);
                if (cell != null && !isCellEmpty(cell)) {
                    return i;
                }
            }
        }
        return 0;
    }
    
    private boolean isCellEmpty(Cell cell) {
        if (cell.getCellType() == CellType.BLANK) return true;
        if (cell.getCellType() == CellType.STRING && cell.getStringCellValue().trim().isEmpty()) return true;
        return false;
    }
    
    private void setupColumnWidths(Sheet sheet) {
        sheet.setColumnWidth(0, 185 * 32); // A
        sheet.setColumnWidth(1, 185 * 32); // B
        sheet.setColumnWidth(2, 140 * 32); // C
        sheet.setColumnWidth(3, 131 * 32); // D
        sheet.setColumnWidth(4, 176 * 32); // E
        sheet.setColumnWidth(5, 208 * 32); // F
        sheet.setColumnWidth(6, 185 * 32); // G
        sheet.setColumnWidth(7, 118 * 32); // H
        sheet.setColumnWidth(8, 152 * 32); // I
        sheet.setColumnWidth(9, 118 * 32); // J
    }
    
    private void createTable(Workbook workbook, Sheet sheet, Map<String, Object[]> data, String tableTitle, int startRow) {
        // Create cell styles
        CellStyle headerStyle = createHeaderStyle(workbook, LIGHT_GREEN);
        CellStyle itemCountStyle = createHeaderStyle(workbook, LIGHT_BLUE);
        CellStyle valueStyle = createHeaderStyle(workbook, LIGHT_GREEN);
        CellStyle passStyle = createStatusStyle(workbook, PASS_GREEN);
        CellStyle failStyle = createStatusStyle(workbook, FAIL_RED);
        CellStyle normalStyle = createNormalStyle(workbook);
        
        // Create title row
        Row titleRow = sheet.createRow(startRow);
        Cell titleCell = titleRow.createCell(0);
        titleCell.setCellValue(tableTitle);
        titleCell.setCellStyle(headerStyle);
        
        // Create header row with merged cells
        Row headerRow = sheet.createRow(startRow + 1);
        
        // Item Count section (merged B2:D2)
        Cell itemCountCell = headerRow.createCell(1);
        itemCountCell.setCellValue("Item Count");
        itemCountCell.setCellStyle(itemCountStyle);
        sheet.addMergedRegion(new CellRangeAddress(startRow + 1, startRow + 1, 1, 3));
        
        // Value cell
        Cell valueCell = headerRow.createCell(4);
        valueCell.setCellValue("Value");
        valueCell.setCellStyle(valueStyle);
        
        // Quantity section (merged F2:H2)
        Cell quantityCell = headerRow.createCell(5);
        quantityCell.setCellValue("Quantity");
        quantityCell.setCellStyle(itemCountStyle);
        sheet.addMergedRegion(new CellRangeAddress(startRow + 1, startRow + 1, 5, 7));
        
        // Other error section (merged I2:J2)
        Cell errorCell = headerRow.createCell(8);
        errorCell.setCellValue("Other error");
        errorCell.setCellStyle(valueStyle);
        sheet.addMergedRegion(new CellRangeAddress(startRow + 1, startRow + 1, 8, 9));
        
        // Create column headers
        Row columnHeaderRow = sheet.createRow(startRow + 2);
        String[] headers = {"ID", "Expected entries", "Actual entries", "Pass/Fail",
                          "Expected Total Value", "Expected Quantity", "Actual Quantity",
                          "Pass/Fail", "Error Details", "Pass/Fail"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = columnHeaderRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(normalStyle);
        }
        
        // Add data rows
        int rowNum = startRow + 3;
        for (Map.Entry<String, Object[]> entry : data.entrySet()) {
            Row row = sheet.createRow(rowNum++);
            Object[] rowData = entry.getValue();
            
            for (int i = 0; i < rowData.length; i++) {
                Cell cell = row.createCell(i);
                
                if (rowData[i] instanceof Number) {
                    cell.setCellValue(((Number) rowData[i]).doubleValue());
                    cell.setCellStyle(normalStyle);
                } else {
                    cell.setCellValue(rowData[i].toString());
                    
                    // Apply conditional formatting for Pass/Fail cells
                    if (rowData[i].toString().equals("Pass") || rowData[i].toString().equals("Fail")) {
                        cell.setCellStyle(rowData[i].toString().equals("Pass") ? passStyle : failStyle);
                    } else {
                        cell.setCellStyle(normalStyle);
                    }
                }
            }
        }
    }
    
    private CellStyle createHeaderStyle(Workbook workbook, IndexedColors color) {
        CellStyle style = workbook.createCellStyle();
        style.setFillForegroundColor(color.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        style.setAlignment(HorizontalAlignment.CENTER);
        style.setVerticalAlignment(VerticalAlignment.CENTER);
        return style;
    }
    
    private CellStyle createStatusStyle(Workbook workbook, IndexedColors color) {
        CellStyle style = workbook.createCellStyle();
        style.setFillForegroundColor(color.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        style.setAlignment(HorizontalAlignment.CENTER);
        return style;
    }
    
    private CellStyle createNormalStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        style.setAlignment(HorizontalAlignment.LEFT);
        return style;
    }
}